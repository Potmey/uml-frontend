<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>UML Process Visualizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6fb;
            padding: 40px;
        }

        h1 {
            margin-bottom: 20px;
        }

        textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            font-size: 16px;
        }

        button {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        .status {
            margin-top: 15px;
            font-weight: bold;
        }

        .error {
            color: red;
        }

        .diagram {
            margin-top: 30px;
            border: 1px solid #ccc;
            background: #fff;
            padding: 10px;
        }

        img {
            max-width: 100%;
        }
    </style>
</head>

<body>

    <h1>UML Process Visualizer</h1>

    <textarea id="process-text">
Employee submits vacation request. Manager approves request.
    </textarea>

    <br />

    <button onclick="processText()">Process</button>

    <div id="status" class="status"></div>

    <div id="diagram" class="diagram" style="display:none;">
        <h3>UML Diagram</h3>
        <img id="uml-image" />
    </div>

<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>

<script>
const BACKEND_URL = "https://uml-backend.onrender.com/analyze";

/* PlantUML encoder (корректный) */
function encodePlantUML(text) {
    const utf8 = new TextEncoder().encode(text);
    const compressed = pako.deflateRaw(utf8, { level: 9 });

    function encode6bit(b) {
        if (b < 10) return String.fromCharCode(48 + b);
        b -= 10;
        if (b < 26) return String.fromCharCode(65 + b);
        b -= 26;
        if (b < 26) return String.fromCharCode(97 + b);
        b -= 26;
        return b === 0 ? '-' : '_';
    }

    function append3bytes(b1, b2, b3) {
        const c1 = b1 >> 2;
        const c2 = ((b1 & 0x3) << 4) | (b2 >> 4);
        const c3 = ((b2 & 0xF) << 2) | (b3 >> 6);
        const c4 = b3 & 0x3F;
        return (
            encode6bit(c1) +
            encode6bit(c2) +
            encode6bit(c3) +
            encode6bit(c4)
        );
    }

    let result = "";
    for (let i = 0; i < compressed.length; i += 3) {
        const b1 = compressed[i];
        const b2 = i + 1 < compressed.length ? compressed[i + 1] : 0;
        const b3 = i + 2 < compressed.length ? compressed[i + 2] : 0;
        result += append3bytes(b1, b2, b3);
    }
    return result;
}

async function processText() {
    const text = document.getElementById("process-text").value.trim();
    const status = document.getElementById("status");
    const diagram = document.getElementById("diagram");

    status.textContent = "Processing...";
    status.className = "status";
    diagram.style.display = "none";

    try {
        const response = await fetch(BACKEND_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text })
        });

        if (!response.ok) {
            throw new Error("Backend error");
        }

        const data = await response.json();

        const encoded = encodePlantUML(data.plantuml);
        const imgUrl = `https://www.plantuml.com/plantuml/svg/${encoded}`;

        document.getElementById("uml-image").src = imgUrl;
        diagram.style.display = "block";

        status.textContent = "Done ✅";

    } catch (err) {
        status.textContent = "Error: " + err.message;
        status.className = "status error";
    }
}
</script>

</body>
</html>
